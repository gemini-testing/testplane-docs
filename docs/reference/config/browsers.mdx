import Admonition from "@theme/Admonition";
import BrowsersBasicFormat from "@site/docs/reference/config/_partials/examples/_browsers-basic-format.mdx";
import BrowsersExample from "@site/docs/reference/config/_partials/examples/_browsers-example.mdx";
import DesiredCapabilitiesExample from "@site/docs/reference/config/_partials/examples/_browsers-desired-capabilities.mdx";
import SessionEnvFlags from "@site/docs/reference/config/_partials/examples/_browsers-session-env-flags.mdx";
import AssertViewOptions from "../../_partials/specs/assert-view-options.mdx";
import Version from "../../_partials/specs/version.mdx";

# browsers

## Overview {#overview}

The `browsers` section is mandatory in Testplane settings. It specifies all the browsers in which the tests will run.

## Setup {#setup}

This section has the following format:

<BrowsersBasicFormat />

Where `<browser-id>` is the name of the browser used for its identification.

To avoid repeating the same settings for different browsers, you can set all the default values you need at the root of the Testplane config. For example:

<BrowsersExample />

In this example, the value `10` will be used for the `sessionsPerBrowser` option for **chrome**, and `5` for **firefox**.

## Main browser settings {#browser_main_settings}

<table>
    <thead>
        <tr>
            <td>**Parameter**</td>
            <td>**Type**</td>
            <td>**Default**</td>
            <td>**Description**</td>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>[`desiredCapabilities`](#desired_caps)</td>
            <td>`DesiredCapabilities`</td>
            <td>_N/A_</td>
            <td>
                Required parameter. Specifies the properties that the browser must have. Used by
                _WebDriver_, see [DesiredCapabilities][desired-caps].
            </td>
        </tr>
        <tr>
            <td>[`gridUrl`](#grid_url)</td>
            <td>`string`</td>
            <td>
                `"http://localhost`
                <br />
                `:4444/wd/hub"`
            </td>
            <td>Selenium grid URL.</td>
        </tr>
        <tr>
            <td>[`baseUrl`](#base_url)</td>
            <td>`string`</td>
            <td>`"http://localhost"`</td>
            <td>Base URL of the service being tested.</td>
        </tr>
        <tr>
            <td>[`browserWSEndpoint`](#browser_ws_endpoint)</td>
            <td>`string`</td>
            <td>`null`</td>
            <td>
                Websocket endpoint for connecting to the browser via [Chrome DevTools Protocol
                (CDP)][how-to-use-cdp].
            </td>
        </tr>
        <tr>
            <td>[`automationProtocol`](#automation_protocol)</td>
            <td>`string`</td>
            <td>`"webdriver"`</td>
            <td>
                Protocol for communication with the browser. See [WebDriver vs
                CDP](../../webdriver-vs-cdp).
            </td>
        </tr>
        <tr>
            <td>[`sessionEnvFlags`](#session_env_flags)</td>
            <td>`SessionEnvFlags`</td>
            <td>`{}`</td>
            <td>
                Environment flags setting the protocol to be used in the created browser session.
            </td>
        </tr>
        <tr>
            <td>[`windowSize`](#window_size)</td>
            <td>`string | WindowSize`</td>
            <td>`null`</td>
            <td>Browser window size.</td>
        </tr>
        <tr>
            <td>[`headless`](#headless)</td>
            <td>`boolean | "new" | "old"`</td>
            <td>_depends on browser_</td>
            <td>Allows running the browser in _headless_ mode.</td>
        </tr>
    </tbody>
</table>

### desiredCapabilities {#desired_caps}

Required parameter. Specifies the properties that the browser must have.

The format of the desiredCapabilities object is defined by the [WebDriver standard](https://www.w3.org/TR/webdriver/#capabilities).

In addition to standard options, some tools provide specific settings in their namespaces.

Browser-specific options:

-   Chrome, `goog:chromeOptions` — [ChromeDriver options documentation](https://developer.chrome.com/docs/chromedriver/capabilities#recognized_capabilities)
-   Firefox, `moz:firefoxOptions` — [Geckodriver documentation](https://firefox-source-docs.mozilla.org/testing/geckodriver/Capabilities.html)
-   Edge, `ms:edgeOptions` — [EdgeDriver documentation](https://learn.microsoft.com/en-us/microsoft-edge/webdriver-chromium/capabilities-edge-options)

Grid-specific browser options:

-   Sauce Labs, `sauce:options` — [documentation](https://docs.saucelabs.com/dev/test-configuration-options/#w3c-webdriver-browser-capabilities--optional)
-   BrowserStack, `bstack:options` — [documentation](https://www.browserstack.com/docs/automate/selenium/organize-tests)
-   TestingBot, `tb:options` — [documentation](https://testingbot.com/support/other/test-options)

Options specific to some automation tools:

-   Appium, `appium:*` — [documentation](https://appium.github.io/appium.io/docs/en/writing-running-appium/caps/)
-   Selenoid, `selenoid:options` — [documentation](https://github.com/aerokube/selenoid/blob/master/docs/special-capabilities.adoc)

Example of an extended `desiredCapabilities` setting:

<DesiredCapabilitiesExample />

### gridUrl {#grid_url}

Grid URL (the address where ChromeDriver/Selenium Standalone/Sauce Labs/etc. listens).

Default: `http://localhost:4444/wd/hub`.

<Admonition type="info">
    You can also use value `"local"` in order to use local browsers, managed by Testplane. Read more
    in guide [How to launch Testplane in the local
    browser](/docs/v8/basic-guides/managing-browsers).
</Admonition>

### baseUrl {#base_url}

Base URL of the service being tested. Allows for more convenient use of the `browser.url` commands:

-   if the target address starts with `/`, `baseUrl` without the path part will be added at the beginning.
-   if the target address does not start with `/`, the entire `baseUrl` will be added at the beginning.
-   it is important whether `/` exists (or not). [See more][url-resolve].

Default: `http://localhost`.

### browserWSEndpoint {#browser_ws_endpoint}

Websocket endpoint for connecting to the browser via [Chrome DevTools Protocol (CDP)][how-to-use-cdp]. For example, you specify `browserWSEndpoint: "ws://YOUR_HOST/devtools"`, to which the browser session identifier will be added at the end: `ws://YOUR_HOST/devtools/12345`, where `12345` is the session identifier.

Default value: `null`. It means that Testplane will try to determine the websocket endpoint automatically.

### automationProtocol {#automation_protocol}

Protocol for communication with the browser. Available values: `webdriver` and `devtools`. See also [WebDriver vs CDP](../../webdriver-vs-cdp). Default: `webdriver`.

### sessionEnvFlags {#session_env_flags}

Environment flags set the protocols that will be used in the created browser session. By default, environment flags are automatically set according to the specified `desiredCapabilities`. However, in rare cases, they may have incorrect values and can be explicitly set using this option.

Available flags:

<table>
    <thead>
        <tr>
            <td>**Flag**</td>
            <td>**Protocols**</td>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>`isW3C`</td>
            <td>
                [WebDriverProtocol](https://webdriver.io/docs/api/webdriver) or by default
                [JsonWProtocol](https://webdriver.io/docs/api/jsonwp)
            </td>
        </tr>
        <tr>
            <td>`isChrome`</td>
            <td>[ChromiumProtocol](https://webdriver.io/docs/api/chromium)</td>
        </tr>
        <tr>
            <td>`isMobile`</td>
            <td>
                [MJsonWProtocol](https://webdriver.io/docs/api/mjsonwp) and
                [AppiumProtocol](https://webdriver.io/docs/api/appium)
            </td>
        </tr>
        <tr>
            <td>`isSauce`</td>
            <td>[Sauce Labs specific commands](https://webdriver.io/docs/api/saucelabs)</td>
        </tr>
        <tr>
            <td>`isSeleniumStandalone`</td>
            <td>
                [Special Selenium commands](https://webdriver.io/docs/api/selenium) when running
                tests in _Selenium Grid_ or using _Selenium Standalone Server_.
            </td>
        </tr>
    </tbody>
</table>

For example:

<SessionEnvFlags />

### windowSize {#window_size}

Browser window size. If not specified, the window size will depend on WebDriver. Can be specified as a string, for example, `800x1000` or as an object with `width` and `height` keys with integer values.

For example:

```typescript
const browserOptions = {
    windowSize: "800x1000",
};
```

and

```typescript
const browserOptions = {
    windowSize: {
        width: 800,
        height: 1000,
    },
};
```

are equivalent.

<Admonition type="warning">
    Setting the resolution for the Opera browser or for mobile browsers does not work as these
    browsers only use fullscreen mode.
</Admonition>

### headless {#headless}

Allows managing the browser's headless mode (without visible browser display). Can be set as a `boolean` value, and from Chrome version 112, can be set as a string `"new" | "old"`. More about the new headless mode — [in Chrome blog](https://developer.chrome.com/docs/chromium/new-headless).

Default: `null` (determined on the browser side).

## Timeouts {#timeouts}

<table>
    <thead>
        <tr>
            <td>**Parameter**</td>
            <td>**Type**</td>
            <td>**Default**</td>
            <td>**Description**</td>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>[`waitTimeout`](#wait_timeout)</td>
            <td>`number`</td>
            <td>`3000`</td>
            <td>Timeout for events on the web page, in ms.</td>
        </tr>
        <tr>
            <td>[`waitInterval`](#wait_interval)</td>
            <td>`number`</td>
            <td>`500`</td>
            <td>Interval for events on the web page, in ms.</td>
        </tr>
        <tr>
            <td>[`httpTimeout`](#http_timeout)</td>
            <td>`number`</td>
            <td>`30000`</td>
            <td>Timeout for any requests to the Selenium server, in ms.</td>
        </tr>
        <tr>
            <td>[`urlHttpTimeout`](#url_http_timeout)</td>
            <td>`number`</td>
            <td>= _httpTimeout_</td>
            <td>Timeout for the _/url_ request to the Selenium server, in ms.</td>
        </tr>
        <tr>
            <td>[`pageLoadTimeout`](#page_load_timeout)</td>
            <td>`number`</td>
            <td>`20000`</td>
            <td>Timeout for the full page load, in ms.</td>
        </tr>
        <tr>
            <td>[`sessionRequestTimeout`](#session_request_timeout)</td>
            <td>`number`</td>
            <td>= _httpTimeout_</td>
            <td>Timeout for the browser session request, in ms.</td>
        </tr>
        <tr>
            <td>[`sessionQuitTimeout`](#session_quit_timeout)</td>
            <td>`number`</td>
            <td>`5000`</td>
            <td>Timeout for ending the session, in ms.</td>
        </tr>
        <tr>
            <td>[`testTimeout`](#test_timeout)</td>
            <td>`number`</td>
            <td>`null`</td>
            <td>
                Timeout for running the test, in ms. If the value is not set, the general timeout
                for all browsers will be used, which is set with the
                [system.mochaOpts.timeout][system-mocha-opts] setting.
            </td>
        </tr>
    </tbody>
</table>

### waitTimeout {#wait_timeout}

Timeout for events on the web page, in milliseconds. Default: `3000` ms (3 seconds).

Applied in the [waitUntil][element-wait-until] command, which is used in all `waitFor*` commands when searching for a specified element on the page.

For example, when executing the `browser.$('.element').click()` command, the `$('element')` subcommand will, by default, wait for the element's existence up to 3000 ms before clicking it.

### waitInterval {#wait_interval}

Interval for events on the web page, in milliseconds. Default: `500` ms.

Applied in the [waitUntil][element-wait-until] command, which is used in all `waitFor*` commands when searching for a specified element on the page.

For example, when executing the `browser.$('.element').click()` command, the `$('element')` subcommand will, by default, check for the existence of the element every 500 ms.

### httpTimeout {#http_timeout}

Timeout for any requests to the Selenium server, in milliseconds. Default: `30000` ms.

### urlHttpTimeout {#url_http_timeout}

Timeout for the `/url` request to the Selenium server, in milliseconds. Sometimes, when opening a link on the server side, a lot of logic is executed in middleware, causing the link to take a long time to open. To avoid increasing the timeout for all commands due to this, Testplane allows you to set a separate timeout for the `/url` request.

### pageLoadTimeout {#page_load_timeout}

Timeout for the full page load, in milliseconds. Default: `20000` ms.

### sessionRequestTimeout {#session_request_timeout}

Timeout for the browser session request, in milliseconds. By default, it takes the value of the `httpTimeout` setting.

### sessionQuitTimeout {#session_quit_timeout}

Timeout for ending the session, in milliseconds. Default: `5000` ms.

### testTimeout {#test_timeout}

Timeout for running the test, in milliseconds. When used for a test suite, it will apply to all tests and hooks within that suite.

If the value is not set, the general timeout for all browsers, set with the [system.mochaOpts.timeout][system-mocha-opts] setting, will be used.

## Running Tests {#test_run_settings}

<table>
    <thead>
        <tr>
            <td>**Parameter**</td>
            <td>**Type**</td>
            <td>**Default**</td>
            <td>**Description**</td>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>[`sessionsPerBrowser`](#sessions_per_browser)</td>
            <td>`number`</td>
            <td>`1`</td>
            <td>Number of sessions that will be run simultaneously for a particular browser.</td>
        </tr>
        <tr>
            <td>[`testsPerSession`](#tests_per_session)</td>
            <td>`number`</td>
            <td>`Infinity`</td>
            <td>
                How many tests can be run sequentially in one browser session. This parameter limits
                the reuse of the session to prevent test failures due to browser degradation, and
                has nothing to do with parallel test execution.
            </td>
        </tr>
        <tr>
            <td>[`retry`](#retry)</td>
            <td>`number`</td>
            <td>`0`</td>
            <td>How many times to retry a failing test.</td>
        </tr>
        <tr>
            <td>[`shouldRetry`](#should_retry)</td>
            <td>`(data: FailedTestData) => boolean`</td>
            <td>_see description_</td>
            <td>
                Function that determines if a retry is needed. By default, a function is set that
                returns _true_ if _retry > 0_ and _false_ if _retry == 0_.
            </td>
        </tr>
        <tr>
            <td>[`strictTestsOrder`](#strict_test_order)</td>
            <td>`boolean`</td>
            <td>`false`</td>
            <td>
                Guarantee strict order of tests. If _true_, the API function _testplane.readTests_
                will always return the same result.
            </td>
        </tr>
        <tr>
            <td>[`passive`](#passive)</td>
            <td>`boolean`</td>
            <td>`false`</td>
            <td>
                Allows making the browser passive. In passive browsers, tests do not run by default.
                _Available since testplane@8.16.0_. **Warning**: it currently has issues, read
                below.
            </td>
        </tr>
        <tr>
            <td>[`openAndWaitOpts`](#open-and-wait-opts)</td>
            <td>`OpenAndWaitOpts`</td>
            <td>_see description_</td>
            <td>Allows setting default options for the `browser.openAndWait` command.</td>
        </tr>
        <tr>
            <td>[`isolation`](#isolation)</td>
            <td>`boolean`</td>
            <td>`true` for Chrome 93+</td>
            <td>Enables isolation mode using browser contexts.</td>
        </tr>
    </tbody>
</table>

### sessionsPerBrowser {#sessions_per_browser}

Number of sessions that will be run simultaneously for a particular browser. Default: `1`.

### testsPerSession {#tests_per_session}

This parameter specifies how many tests can be run sequentially in one browser session. It can be useful to limit the reuse of the session. If the same browser session is used many times for running different tests, at some point the browser may start to degrade. This can affect the test run, leading to failures. Once the limit of tests is reached, the session will be closed and a new session will start.

Default: `Infinity`. This means the session will be reused an infinite number of times. However, in real operations, there may be limitations from the grid on which the browsers are running. For example, the grid may limit the maximum lifetime of a session, and then the number of tests that can be run within a session will be determined by its lifetime.

<Admonition type="warning">
    Be careful: this parameter has nothing to do with parallel test execution.
</Admonition>

### retry {#retry}

How many times to retry a test if it fails. Default: `0`.

### shouldRetry {#should_retry}

Function that determines if a retry is needed. Should return a `Boolean` value. By default, a function is set that returns `true` if there are still retries available, and `false` if the retry limit for the test has been reached (see [retry](#retry) setting).

The argument of this function is an object with the following fields:

```typescript
interface FailedTestData {
    ctx: {
        id(): string;
        browserId: string;
        sessionId: string;
    };
    retriesLeft: number;
    error?: Error;
}
```

### strictTestsOrder {#strict_test_order}

This option guarantees strict order of reading tests. Default: `false`.

### passive {#passive}

<Admonition type="warning">
    Available since testplane@8.16.0.

    This option currently doesn't work well with html-reporter. For now, we recommend to keep using the [hermione-passive-browsers](https://github.com/gemini-testing/testplane-passive-browsers) plugin. Note that the plugin and this option must not be used together. We're already working on a fix.

</Admonition>

Allows making the browser passive. In passive browsers, tests do not run by default. Using the helper [`testplane.also.in`][testplane-also-in-helper], you can enable a test or suite before it is run.

Default: `false`.

### openAndWaitOpts {#open-and-wait-opts}

Allows setting options to be used when calling the [`browser.openAndWait`](../../../commands/browser/openAndWait) command.

Default:

```typescript
const defaultOpenAndWaitOpts = {
    waitNetworkIdle: true,
    waitNetworkIdleTimeout: 500,
    failOnNetworkError: true,
    ignoreNetworkErrorsPatterns: [],
};
```

### isolation {#isolation}

Enables running tests in [isolated browser contexts](https://chromedevtools.github.io/devtools-protocol/tot/Target/#method-createBrowserContext). This means that `testsPerSession` can be set to `Infinity` to run all tests in one session and significantly speed up the test run.

Works starting from Chrome 93 and higher.

Default: `true` for Chrome 93 and higher, `false` otherwise.

## Test and Failure Information {#info_when_test_fails}

<table>
    <thead>
    <tr><td>**Parameter**</td><td>**Type**</td><td>**Default**</td><td>**Description**</td></tr>
    </thead>
    <tbody>
    <tr><td>[`meta`](#meta)</td><td>`Record<string, any>`</td><td>_N/A_</td><td>Additional data that will be returned by the _getMeta()_ command.</td></tr>
    <tr><td>[`takeScreenshotOnFails`](#take_screenshot_on_fails)</td><td>`ScreenshotOnFails`</td><td>`{ testFail: true, assertViewFail: true }`</td><td>Determines whether to take a screenshot of the browser page _(Page Screenshot)_ on test failure, as well as on _assertView_ command failure.</td></tr>
    <tr><td>[`takeScreenshotOnFailsMode`](#take_screenshot_on_fails_mode)</td><td>`"viewport" | "fullpage"`</td><td>`"fullpage"`</td><td>Mode for taking a screenshot upon test failure.</td></tr>
    <tr><td>[`takeScreenshotOnFailsTimeout`](#take_screenshot_on_fails_timeout)</td><td>`number`</td><td>`5000`</td><td>Timeout for taking a screenshot of the browser page _(Page Screenshot)_ upon test failure, in ms.</td></tr>
    <tr><td>[`saveHistoryMode`](#save_history_mode)</td><td>`"all" | "none" | "onlyFailed"`</td><td>`"all"`</td><td>Save the history of all commands executed.</td></tr>
    </tbody>
</table>

### meta {#meta}

Additional data that will be returned by the `getMeta()` command. Data can also be added "on the fly" using the `setMeta()` command: before, during, or after the test run.

### takeScreenshotOnFails {#take_screenshot_on_fails}

This option is set as an object:

```typescript
interface ScreenshotOnFails {
    testFail: boolean;
    assertViewFail: boolean;
}
```

These keys determine whether to take a screenshot of the browser page _(Page Screenshot)_ upon test failure and upon `assertView` command failure, respectively. In the case of `testFail`, all test failures except those due to `assertView` commands are taken into account.

Default: `{ testFail: true, assertViewFail: true }`.

### takeScreenshotOnFailsMode {#take_screenshot_on_fails_mode}

Mode for taking a screenshot of the browser page upon test failure. Available values: `viewport` and `fullpage`:

-   `viewport` — take a screenshot of the current viewport.
-   `fullpage` — take a screenshot of the entire browser page.

Default: `fullpage`.

### takeScreenshotOnFailsTimeout {#take_screenshot_on_fails_timeout}

Timeout for taking a screenshot of the browser page upon test failure, in milliseconds. Default: `5000` ms.

### saveHistoryMode {#save_history_mode}

<Admonition type="warning">Available since hermione@7.</Admonition>

Save the history of all commands executed. Default: `all`.

Available values:

-   `all` — history is enabled.
-   `none` — history is disabled.
-   `onlyFailed` — history is saved only for failed tests.

Some plugins may rely on this history, such as [html-reporter][html-reporter].

History is accessible from the following events — `TEST_END`, `TEST_PASS`, `TEST_FAIL` — via `payload`. Example of a plugin that uses the history:

```typescript
exports = testplane => {
    testplane.on(testplane.events.TEST_PASS, async test => {
        console.log(test.history);
    });
};
```

## Preparing for Screenshot Taking {#prepare_to_take_screenshot}

<table>
    <thead>
        <tr>
            <td>**Parameter**</td>
            <td>**Type**</td>
            <td>**Default**</td>
            <td>**Description**</td>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>[`calibrate`](#calibrate)</td>
            <td>`boolean`</td>
            <td>`false`</td>
            <td>Perform calibration before taking a screenshot.</td>
        </tr>
        <tr>
            <td>[`orientation`](#orientation)</td>
            <td>`string`</td>
            <td>`null`</td>
            <td>Browser window orientation to set before each test run.</td>
        </tr>
        <tr>
            <td>[`waitOrientationChange`](#wait_orientation_change)</td>
            <td>`boolean`</td>
            <td>`true`</td>
            <td>Wait for actual orientation change.</td>
        </tr>
        <tr>
            <td>[`resetCursor`](#reset_cursor)</td>
            <td>`boolean`</td>
            <td>`true`</td>
            <td>Move cursor to point _(0, 0)_ in _body_ coordinates before each test run.</td>
        </tr>
        <tr>
            <td>[`screenshotsDir`](#screenshots_dir)</td>
            <td>`string | (test: Test) => string`</td>
            <td>`"./testplane/screens"`</td>
            <td>
                Folder for saving reference screenshots with the _assertView_ command. By default
                _testplane/screens_ relative to the working directory: _process.cwd()_.
            </td>
        </tr>
    </tbody>
</table>

### calibrate {#calibrate}

Perform calibration before taking a screenshot. In some WebDriver implementations, when taking a screenshot, UI elements of the browser itself may appear on the image. Calibration helps solve this issue. Default: `false`.

### orientation {#orientation}

Browser window orientation to set before each test run. Available values: `landscape`, `portrait`, `null`. Default: `null`.

<Admonition type="tip" title="Which value to choose for orientation?">
    It depends on the orientation in which most of your tests are executed. If the majority of tests
    are run in _landscape_ mode, set the _orientation_ value to _landscape_. Then, tests that
    require _portrait_ orientation will set their desired orientation themselves. The _orientation_
    option will ensure that all other tests will be run with the _landscape_ orientation
    automatically without needing to set it in each test.
</Admonition>

### waitOrientationChange {#wait_orientation_change}

Wait for actual orientation change. Default: `true`. When set to `true`, testplane ensures that the `setOrientation` command will complete only after the orientation is actually changed to the specified one.

### resetCursor {#reset_cursor}

Move the cursor to point _(0, 0)_ in _body_ coordinates before each test run. Default: `true`. It may be needed in cases where the default cursor position affects test execution. For example, when a tooltip _(hint)_ pops up because of the cursor, which "spoils" the screenshot being taken.

<Admonition type="tip">
    It is recommended to reset the cursor for desktop browsers and not for mobile ones.
</Admonition>

### screenshotsDir {#screenshots_dir}

Folder for saving reference screenshots with the `assertView` command. By default, it is the `testplane/screens` folder relative to the working directory: `process.cwd()`. The value of this option can also be a function that takes one argument — the test instance within which the `assertView` command was called, for example:

```typescript
const browserOptions = {
    screenshotsDir: test => `tests/screenshots/${test.parent.title}`,
};
```

## Taking and Comparing Screenshots {#taking_screenshots}

<table>
    <thead>
        <tr>
            <td>**Parameter**</td>
            <td>**Type**</td>
            <td>**Default**</td>
            <td>**Description**</td>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>[`tolerance`](#tolerance)</td>
            <td>`number`</td>
            <td>`2.3`</td>
            <td>
                Maximum allowed [CIEDE2000](http://en.wikipedia.org/wiki/Color_difference#CIEDE2000)
                difference between colors.
            </td>
        </tr>
        <tr>
            <td>[`antialiasingTolerance`](#antialiasing_tolerance)</td>
            <td>`number`</td>
            <td>`4`</td>
            <td>
                Sets the sensitivity for detecting antialiasing, which will be ignored when
                comparing screenshots.
            </td>
        </tr>
        <tr>
            <td>[`compareOpts`](#compare_opts)</td>
            <td>`CompareOpts`</td>
            <td>_[see below](#compare_opts)_</td>
            <td>Options for image comparison.</td>
        </tr>
        <tr>
            <td>[`buildDiffOpts`](#build_diff_opts)</td>
            <td>`BuildDiffOpts`</td>
            <td>_[see below](#build_diff_opts)_</td>
            <td>Options for building the diff (image showing differences between screenshots).</td>
        </tr>
        <tr>
            <td>[`assertViewOpts`](#assert_view_opts)</td>
            <td>`AssertViewOpts`</td>
            <td>_[see below](#assert_view_opts)_</td>
            <td>Default options for the _assertView_ command.</td>
        </tr>
        <tr>
            <td>[`compositeImage`](#composite_image)</td>
            <td>`boolean`</td>
            <td>`true`</td>
            <td>Allows testing elements that do not fit within the viewport height.</td>
        </tr>
        <tr>
            <td>[`screenshotMode`](#screenshot_mode)</td>
            <td>`"auto" | "fullpage" | "viewport"`</td>
            <td>`"auto"`</td>
            <td>Screenshot mode.</td>
        </tr>
        <tr>
            <td>[`screenshotDelay`](#screenshot_delay)</td>
            <td>`number`</td>
            <td>`0`</td>
            <td>Delay before taking the screenshot, in ms.</td>
        </tr>
    </tbody>
</table>

### tolerance {#tolerance}

Maximum allowed [CIEDE2000](http://en.wikipedia.org/wiki/Color_difference#CIEDE2000) difference between colors. Used only in non-strict mode. Default: `2.3`. Starting from the value `2.3`, the color difference becomes perceptible to the human eye. The smaller the value, the stricter the screenshot comparison.

It is not recommended to increase the `tolerance` value globally. Instead, try setting `tolerance` for specific test suites or states.

Here's how to take a screenshot for a specific state with an individual `tolerance` setting:

```typescript
it("some-test", async function (browser) {
    await browser.assertView("some-state", ".selector1", { tolerance: 10 });
    await browser.assertView("another-state", ".selector1");
});
```

### antialiasingTolerance {#antialiasing_tolerance}

Sets the sensitivity for detecting antialiasing, which will be ignored when comparing screenshots.

Read more about this option in the [looks-same](https://github.com/gemini-testing/looks-same#comparing-images-with-ignoring-antialiasing) package.

### compareOpts {#compare_opts}

Additional options for image comparison. See the list of available options in the [looks-same](https://github.com/gemini-testing/looks-same#comparing-images) documentation.

Default:

```typescript
const defaultCompareOpts = {
    shouldCluster: false,
    clustersSize: 10,
    stopOnFirstFail: false,
};
```

### buildDiffOpts {#build_diff_opts}

Additional options for building the diff (image showing the differences between screenshots). See the list of available options in the [looks-same](https://github.com/gemini-testing/looks-same#building-diff-image) documentation. Default:

```typescript
const defaultBuildDiffOpts = {
    ignoreAntialiasing: true,
    ignoreCaret: true,
};
```

### assertViewOpts {#assert_view_opts}

Options for the `assertView` command to take and compare screenshots, which will be used by default. They can be overridden when calling the `assertView` command.

Available `assertView` options:

<AssertViewOptions />

Default:

```typescript
const defaultAssertViewOpts = {
    ignoreElements: [],
    captureElementFromTop: true,
    allowViewportOverflow: false,
    disableAnimation: true,
    ignoreDiffPixelCount: 0,
};
```

### compositeImage {#composite_image}

Allows testing elements that do not fit within the viewport height. Default: `true`. If the tested block is taller than the viewport, the images of several viewports are stitched together into one image.

### screenshotMode {#screenshot_mode}

Screenshot mode. Default: `auto`.

Possible values:

-   `"auto"` — the mode will be determined automatically.
-   `"fullpage"` — a screenshot of the entire page will be taken.
-   `"viewport"` — only the viewport will be captured in the screenshot.

By default, the `viewport` mode is set for android browsers to bypass a [bug in Chromium](https://bugs.chromium.org/p/chromedriver/issues/detail?id=2853).

In desktop browsers, it is possible to get an image of the entire page out of the box, without manually stitching images of separate viewports into one large screenshot. However, on mobile devices, there is no such functionality.

### screenshotDelay {#screenshot_delay}

Delay in milliseconds before taking the screenshot. Default: `0` ms. The delay can be helpful in cases where the page contains elements using animation or a scrollbar that does not disappear immediately and affects the resulting screenshot.

## Request and Response Parameters {#params_of_requests_and_responses}

<table>
    <thead>
    <tr><td>**Parameter**</td><td>**Type**</td><td>**Default**</td><td>**Description**</td></tr>
    </thead>
    <tbody>
    <tr><td>[`agent`](#agent)</td><td>`object`</td><td>`null`</td><td>Allows setting custom [agents][got-agent] for _http, https, http2_ requests.</td></tr>
    <tr><td>[`headers`](#headers)</td><td>`Record<string, string>`</td><td>`null`</td><td>Allows setting custom [headers][got-headers] to be sent with each WebDriver request.</td></tr>
    <tr><td>[`transformRequest`](#transform_request)</td><td>`TransformRequestFn`</td><td>`null`</td><td>Allows intercepting and transforming [http-request options][got-options] before the request is sent to WebDriver.</td></tr>
    <tr><td>[`transformResponse`](#transform_response)</td><td>`TransformResponseFn`</td><td>`null`</td><td>Allows intercepting and transforming [http-response][got-response] received from WebDriver.</td></tr>
    <tr><td>[`strictSSL`](#strict_ssl)</td><td>`boolean`</td><td>`null`</td><td>Whether the SSL certificate must be valid.</td></tr>
    </tbody>
</table>

### agent {#agent}

Allows setting custom [agents][got-agent] for _http, https, http2_ requests. Default: `null` (in this case, default http agents from the [got][got] package will be used).

### headers {#headers}

Allows setting custom [headers][got-headers] to be sent with each WebDriver request. Default: `null`. See also in the `WebDriverIO` [documentation](https://webdriver.io/docs/options/#headers).

<Admonition type="warning">
    These headers are not sent in requests from the browser where the tests are executed. They are
    sent only in requests to WebDriver.
</Admonition>

### transformRequest {#transform_request}

Allows intercepting and transforming [http-request options][got-options] before the request is sent to WebDriver. Default: `null`. If a function is passed, the `RequestOptions` object will be passed as the first argument. The function should return the modified `RequestOptions`.

Function type:

```typescript
type TransformRequestFn = (req: RequestOptions) => RequestOptions;
```

By default, this function is used to generate the `X-Request-ID` header. This header has the format `${FIRST_X_REQ_ID}__${LAST_X_REQ_ID}`, where:

-   `FIRST_X_REQ_ID` - a unique UUID for each test (different for each retry), allows finding all requests related to the specific test run;
-   `LAST_X_REQ_ID` - a unique UUID for each request to the browser within one test, in combination with `FIRST_X_REQ_ID` it allows finding the specific request.

Example value: `2f31ffb7-369d-41f4-bbb8-77744615d2eb__e8d011d8-bb76-42b9-b80e-02f03b8d6fe1`.

The `X-Request-ID` header can be useful for debugging problematic requests if you use your own browser grid and save request logs.

You can generate `X-Request-ID` in your format using `transformRequest`. Example:

```typescript
const transformRequest = req => {
    req.headers["X-Request-ID"] = "my_x_req_id";

    return req;
};
```

### transformResponse {#transform_response}

Allows intercepting and transforming the [http-response][got-response] received from WebDriver. Default: `null`. If a function is passed, the `Response` object will be passed as the first argument, and the `RequestOptions` as the second argument. The function should return the modified `Response`.

Function type:

```typescript
type TransformResponsetFn = (res: Response, req: RequestOptions) => Response;
```

### strictSSL {#strict_ssl}

Whether the SSL certificate must be valid. If not set, the [default value][strict-ssl] from WebDriverIO will be used.

## Cloud Settings {#cloud_settings}

The following settings may be useful if you want to run your testplane tests in browsers of cloud services.

An example of such a cloud service could be [SauceLabs][sauce-labs], which [can provide](https://saucelabs.com/platform/cross-browser-testing) you with both desktop and mobile browsers for running tests.

<table>
    <thead>
        <tr>
            <td>**Parameter**</td>
            <td>**Type**</td>
            <td>**Default**</td>
            <td>**Description**</td>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>`user`</td>
            <td>`string`</td>
            <td>`null`</td>
            <td>Username in the cloud service.</td>
        </tr>
        <tr>
            <td>`key`</td>
            <td>`string`</td>
            <td>`null`</td>
            <td>Access key or secret key for accessing the cloud service.</td>
        </tr>
        <tr>
            <td>`region`</td>
            <td>`string`</td>
            <td>`null`</td>
            <td>Allows selecting different data centers in the cloud service.</td>
        </tr>
        <tr>
            <td>`headless`</td>
            <td>`string`</td>
            <td>`null`</td>
            <td>Allows running a headless browser in the cloud service.</td>
        </tr>
    </tbody>
</table>

### user {#user}

Username in the cloud service. Default: `null`.

### key {#key}

Access key or secret key for accessing the cloud service. Default: `null`.

### region {#region}

Allows selecting different data centers in the cloud service. Default: `null`.

### headless {#headless}

Allows running a headless browser in the cloud service. Default: `null`.

## Time Travel {#time_travel}

These settings allow you to configure test run snapshot recording for subsequent playback in the player.
To learn more about Time Travel capabilities, see the [Time Travel guide][time-travel].

<table>
    <thead>
        <tr>
            <td>**Parameter**</td>
            <td>**Type**</td>
            <td>**Default**</td>
            <td>**Description**</td>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>`timeTravel`</td>
            <td>`string | TimeTravelSettings`</td>
            <td>`"off"`</td>
            <td>Time Travel settings.</td>
        </tr>
    </tbody>
</table>

### timeTravel {#time_travel}

Time Travel settings. Default: `"off"`.

For quick setup, you can pass a string — one of the recording modes (`TimeTravelMode`). The full configuration looks like this:

```typescript
enum TimeTravelMode {
    // Snapshot recording is enabled for all runs
    On = "on",
    // Snapshot recording is disabled
    Off = "off",
    // Snapshot recording is enabled for all retries (first run is not considered a retry)
    RetriesOnly = "retries-only",
    // Snapshot recording is enabled for all runs, but only snapshots for the last failed run are saved
    // For example:
    // - if the test was run once and failed, the snapshot will be recorded.
    // - if the test was run 5 times and failed all 5 times, the snapshot for the 5th retry will be recorded.
    // - if the test was run 2 times and passed both times, no snapshots will be recorded.
    LastFailedRun = "last-failed-run",
}

interface TimeTravelConfig {
    mode: TimeTravelMode;
}
```

Example of a valid configuration:

```typescript
import { TimeTravelMode } from "@testplane/testplane";

export = {
    timeTravel: {
        mode: TimeTravelMode.RetriesOnly,
    },
};
```

## Selectivity {#selectivity}

This section allows you to configure Testplane's selective test execution, avoiding the launch of tests for which nothing has changed.

The section has the following parameters:

<table>
    <thead>
        <tr>
            <td>**Parameter**</td>
            <td>**Type**</td>
            <td>**Default**</td>
            <td>**Description**</td>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>`enabled`</td>
            <td>`boolean`</td>
            <td>`false`</td>
            <td>Enables selective test execution.</td>
        </tr>
        <tr>
            <td>`sourceRoot`</td>
            <td>`string`</td>
            <td>`""`</td>
            <td>Configures the path to the root of the source code files.</td>
        </tr>
        <tr>
            <td>`testDependenciesPath`</td>
            <td>`string`</td>
            <td>`".testplane/selectivity"`</td>
            <td>The path to the directory where test dependency data will be saved.</td>
        </tr>
        <tr>
            <td>`compression`</td>
            <td>`"none" | "gz" | "br" | "zstd"`</td>
            <td>`"gz"`</td>
            <td>The compression type applied to the test dependency data.</td>
        </tr>
        <tr>
            <td>`disableSelectivityPatterns`</td>
            <td>`string[]`</td>
            <td>`[]`</td>
            <td>
                A list of patterns. If a file matching one of these patterns is changed, selectivity
                will be disabled.
            </td>
        </tr>
        <tr>
            <td>`mapDependencyRelativePath`</td>
            <td>`null | (dependency: { scope: "browser" | "testplane", relativePath: string }) => string | void`</td>
            <td>`null`</td>
            <td>
                Callback, which accepts test dependency path in POSIX style and maps it to another path
                or filters it completely if `falsy` value is returned
            </td>
        </tr>
    </tbody>
</table>

### `mapDependencyRelativePath` examples {#mapDependencyRelativePath_examples}

#### Ignore Next.js internal dependencies {#mapDependencyRelativePath_example_nextjs}

```ts
{
    selectivity: {
        enabled: true,
        mapDependencyRelativePath({relativePath}) {
            if (relativePath.startsWith("turbopack://")) {
                return;
            }

            return relativePath;
        },
    }
}
```

#### Usage with @testplane/storybook plugin {#mapDependencyRelativePath_example_testplane_storybook}

```ts
{
    selectivity: {
        enabled: true,
        mapDependencyRelativePath({relativePath}) {
            // Testplane storybook autogenerated tests
            if (relativePath.includes("/testplane-storybook-autogenerated/")) {
                return;
            }

            // Storybook fake dependencies
            if (relativePath === "storybook-stories.js" || relativePath === "storybook-config-entry.js") {
                return;
            }

            return relativePath;
        },
    }
}
```

<Admonition type="info">
    You should not specify `node_modules` in `disableSelectivityPatterns`, as this will cause a
    significant slowdown. Instead, it is recommended to specify Testplane configuration files and
    the application's backend source code.
</Admonition>

## stateOpts {#state_opts}

<Version version="8.40.0" />

Default settings for state commands.

You can set parameters once and then use state commands ([saveState][saveState], [restoreState][restoreState], [getState][getState]) without specifying options.
However, if you explicitly provide parameters for a command, they will have the highest priority.

<table>
    <thead>
        <tr>
            <td>**Parameter**</td>
            <td>**Type**</td>
            <td>**Default**</td>
            <td>**Description**</td>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>`stateOpts`</td>
            <td>`StateOpts`</td>
            <td>`undefined`</td>
            <td>Default options for state commands.</td>
        </tr>
    </tbody>
</table>

```typescript
type StateOpts = {
    path?: string;
    cookies?: boolean;
    localStorage?: boolean;
    sessionStorage?: boolean;
    cookieFilter?: (cookie: Cookie) => boolean;
    keepFile?: boolean;
};
```

Example of a valid configuration:

```typescript
export = {
    stateOpts: {
        path: "stateDump.json",
    },
};
```

[desired-caps]: https://github.com/SeleniumHQ/selenium/wiki/DesiredCapabilities
[html-reporter]: ../../../html-reporter/html-reporter-setup
[got]: https://github.com/sindresorhus/got/
[got-agent]: https://github.com/sindresorhus/got/blob/main/documentation/2-options.md#agent
[got-headers]: https://github.com/sindresorhus/got/blob/main/documentation/2-options.md#headers
[got-options]: https://github.com/sindresorhus/got/blob/main/documentation/2-options.md
[got-response]: https://github.com/sindresorhus/got/blob/main/documentation/3-streams.md#response-2
[strict-ssl]: https://webdriver.io/docs/options/#strictssl
[read-tests]: ../browsers
[sauce-labs]: https://saucelabs.com
[system-mocha-opts]: ../system#mocha_opts
[element-wait-until]: ../../../commands/element/waitUntil
[how-to-use-cdp]: ../../../guides/how-to-use-cdp
[testplane-also-in-helper]: ../../testplane-helper
[time-travel]: ../../../basic-guides/time-travel
[saveState]: ../../../commands/browser/saveState
[restoreState]: ../../../commands/browser/restoreState
[getState]: ../../../commands/browser/getState
[url-resolve]: https://nodejs.org/api/url.html#urlresolvefrom-to
