import Admonition from "@theme/Admonition";

# @testplane/storybook

## Overview {#overview}

Use the [@testplane/storybook][testplane-storybook] plugin to automatically check the changes in your Storybook components with screenshot testing without a single line of test code.

This plugin adds:

-   automatic screenshot tests for storybook stories;
-   an ability to write Testplane tests for storybook stories right inside of the stories.

## Installation {#install}

```bash
npm install @testplane/storybook --save-dev
```

## Setup {#setup}

<Admonition type="info">Storybook 6.4+ is required to use this plugin.</Admonition>

### Storybook

If you use `storybook@6`, you will need to enable [buildStoriesJson][build-stories] feature in your `storybook` config:

```typescript tytle=".storybook/main.js"
export default {
    // ...
    features: {
        // ...
        buildStoriesJson: true,
    },
};
```

You don't need to do this with storybook@7 or storybook@8.

### Testplane

Add `@testplane/storybook` plugin into your Testplane config:

```typescript title=".testplane.conf.ts"
export default {
    plugins: {
        "@testplane/storybook": {},

        // other Testplane plugins...
    },

    // other Testplane settings...
};
```

With this minimal config, you will be able to run `npx testplane --storybook` to autotest each storybook story with [Testplane assertView][assert-view] command. Testplane will open each story, wait for play function to finish (if defined), and then call `assertView` command. These tests would be generated in runtime.

### Description of configuration parameters {#setup_description}

<table>
    <thead>
        <tr>
            <td>**Parameter**</td>
            <td>**Type**</td>
            <td>**Default**</td>
            <td>**Description**</td>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>enabled</td>
            <td>`Boolean`</td>
            <td>true</td>
            <td>Enable / disable plugin.</td>
        </tr>
        <tr>
            <td>storybookConfigDir</td>
            <td>`String`</td>
            <td>".storybook"</td>
            <td>Path to the storybook configuration directory.</td>
        </tr>
        <tr>
            <td>autoScreenshots</td>
            <td>`Boolean`</td>
            <td>true</td>
            <td>Enable / disable auto-screenshot tests</td>
        </tr>
        <tr>
            <td>localport</td>
            <td>`Number`</td>
            <td>6006</td>
            <td>Port to launch storybook dev server on.</td>
        </tr>
        <tr>
            <td>remoteStorybookUrl</td>
            <td>`String`</td>
            <td>""</td>
            <td>URL of the remote Storybook. If specified, local storybook dev sever would not be launched.</td>
        </tr>
        <tr>
            <td>browserIds</td>
            <td>`Array<String | RegExp>`</td>
            <td>[]</td>
            <td>Array of `browserId` to run storybook tests on. By default, all of browsers, specified in Testplane config would be used</td>
        </tr>
    </tbody>
</table>

<Admonition type="info">
    Storybook tests performance greatly depends on [Testplane testsPerSession][testsPerSession]
    parameter, as these tests speeds up on reusing existing sessions, so setting values around 20+
    is preferred. These tests ignore [Testplane isolation][isolation]. It would be turned off
    unconditionally.
</Admonition>

## Advanced usage

If you have `ts-node` in your project, you can write your Testplane tests right inside of storybook story files:

<Admonition type="info">
    Storybook story files must have `.js` or `.ts` extension for this to work. Formats `jsx/tsx` are
    not supported yet.
</Admonition>

```typescript title="stories/Primary.stories.ts"
import type { StoryObj } from "@storybook/react";
import type { WithTestplane } from "@testplane/storybook";

export const Primary: WithTestplane<StoryObj> = {
    args: {
        primary: true,
        label: "Button",
    },
    testplane: {
        "my test": async ({ browser, expect }) => {
            const element = await browser.$(".storybook-button");

            await expect(element).toHaveText("Button");
        },
    },
};
```

You can also specify extra options in story default config:

```typescript
import type { WithTestplane } from "@testplane/storybook";
import type { Meta, StoryObj } from "@storybook/react";

const meta: WithTestplane<Meta<typeof Button>> = {
    title: "Example/Button",
    component: Button,
    testplane: {
        skip: false, // if true, skips all Testplane tests from this story file
        autoscreenshotSelector: ".my-selector", // Custom selector to auto-screenshot elements
        browserIds: ["chrome"], // Testplane browsers to run tests from this story file
        assertViewOpts: {
            // override default assertView options for tests from this file
            ignoreDiffPixelCount: 5,
        },
    },
};

export default meta;
```

If you decide to create separate config for storybook auto-tests (which is suggested), you need to specify config path via CLI option. For example:

```bash
npx testplane --storybook -c .testplane.storybook.conf.ts
```

This allows you to store references next to your story files:

```typescript title=".testplane.conf.ts"
import path from "path";
import { getStoryFile } from "@testplane/storybook";

export default {
    screenshotsDir: test => {
        const relativeStoryFilePath = getStoryFile(test);
        const relativeStoryFileDirPath = path.dirname(relativeStoryFilePath);

        return path.join(relativeStoryFileDirPath, "screens", test.id, test.browserId);
    },
    // other Testplane settings...
};
```

In this example, screenshot references would be stored in `screens/<testId>/<browserId>` folder, next to each of your story files.

## Useful links {#useful_links}

-   [@testplane/storybook plugin sources][testplane-storybook]
-   [assertView command][assert-view]

[assert-view]: ../commands/browser/assertView.mdx
[build-stories]: https://storybook.js.org/docs/6.4/configure/overview#feature-flags
[isolation]: ../config/browsers.mdx#isolation
[testplane-storybook]: https://github.com/gemini-testing/testplane-storybook
[testplane]: https://github.com/gemini-testing/testplane
[testsPerSession]: ../config/browsers.mdx#tests_per_session
